# mq-controller
Controller for Monique.

## Назначение

Контроллер предоставляет пользователям системы Monique возможность работать с некоторыми компонентами, как с воркерами.

Каждый из компонентов, подключённых к контроллеру, может получать сообщения не напрямую по **SUB** от scheduler'а, а через **PULL** от контроллера.

Это делает возможным схему, когда существует некоторый пул компонентов, занимающихся обработкой однотипных задач, но при этом не выполняющих одни и
те же задания по несколько раз.

## Сборка и запуск

Сборка и запуск компонента производится с помощью инструмента [stack](https://www.haskellstack.org/):

```
stack build
stack exec mq-controller
```

## Конфигурация

Для каждого **spec**'а сообщений, обработка которых компонентами может производиться по описанной выше схеме, заводится отдельный контроллер,
работающий на своём порту.

Информация о разворачиваемых контроллерах записывается в config.json в поле **connections** секции **params/mq_controller**:

```
"params":{
  "mq_controller": {
    "connections": {
      "<spec_сообщения>": <порт_контроллера>,
      "<spec_сообщения>": <порт_контроллера>
    } 
  }
}
```

## Логика работы

При запуске приложения **mq-controller** из config.json считывается информация о том, для каких сообщений нужно поднять контроллеры.

После этого в отдельных форках от основного потока приложения на соответствующих портах поднимаются сами контроллеры.

Раз в минуту приложение проверяет config.json на предмет того, не добавились ли в поле *connections* новые конфигурации для контроллеров.

Если конфигурации добавились, то соответствующие контроллеры будут развёрнуты. Если какие-то конфигурации изменились или были удалены, то
приложение **НИКАК НЕ ОБРАБОТАЕТ** эти случаи.
